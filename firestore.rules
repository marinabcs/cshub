rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Função para verificar se é usuário Trakto autenticado
    function isTraktoUser() {
      return request.auth != null &&
             request.auth.token.email.matches('.*@trakto\\.io$');
    }

    // Regra para collectionGroup - permite buscar todos os documentos 'historico'
    // Necessário para agregar métricas de uso de todos os usuários de um cliente
    match /{path=**}/historico/{data} {
      allow read: if isTraktoUser();
    }

    // Usuários do Sistema (admins, CS, gestores)
    match /usuarios_sistema/{userId} {
      allow read, write: if isTraktoUser();
    }

    // Usuários (collection original - mantida para compatibilidade)
    match /usuarios/{userId} {
      allow read, write: if isTraktoUser();
    }

    // Clientes e subcollections
    match /clientes/{clienteId} {
      allow read, write: if isTraktoUser();

      // Threads
      match /threads/{threadId} {
        allow read, write: if isTraktoUser();

        // Mensagens
        match /mensagens/{mensagemId} {
          allow read, write: if isTraktoUser();
        }
      }

      // Histórico de Health Score
      match /health_history/{historyId} {
        allow read, write: if isTraktoUser();
      }

      // Uso da Plataforma
      match /uso_plataforma/{periodoId} {
        allow read, write: if isTraktoUser();
      }

      // Playbooks ativos do cliente
      match /playbooks_ativos/{playbookAtivoId} {
        allow read, write: if isTraktoUser();
      }
    }

    // Configurações do sistema
    match /config/{configId} {
      allow read, write: if isTraktoUser();
    }

    // Alertas
    match /alertas/{alertaId} {
      allow read, write: if isTraktoUser();
    }

    // Times com subcollections
    match /times/{timeId} {
      allow read, write: if isTraktoUser();

      // Usuarios do time (métricas de uso da plataforma)
      match /usuarios/{userId} {
        allow read, write: if isTraktoUser();

        // Histórico diário do usuário
        match /historico/{data} {
          allow read, write: if isTraktoUser();
        }
      }

      // Threads dentro de times
      match /threads/{threadId} {
        allow read, write: if isTraktoUser();

        // Mensagens dentro de threads
        match /mensagens/{mensagemId} {
          allow read, write: if isTraktoUser();
        }
      }
    }

    // Usuarios Lookup
    match /usuarios_lookup/{docId} {
      allow read, write: if isTraktoUser();
    }

    // Playbooks (templates)
    match /playbooks/{playbookId} {
      allow read, write: if isTraktoUser();
    }

    // Logs de Auditoria
    match /audit_logs/{logId} {
      allow read: if isTraktoUser();
      allow create: if isTraktoUser();
      // Logs são imutáveis - não permite update/delete
      allow update, delete: if false;
    }
  }
}
